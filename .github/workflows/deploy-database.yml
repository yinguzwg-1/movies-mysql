name: ğŸš€ æ•°æ®åº“éƒ¨ç½²åˆ°é˜¿é‡Œäº‘

on:
  push:
    branches: [ main, master ]
    paths:
      - 'database.sql'
      - '.github/workflows/deploy-database.yml'
  workflow_dispatch:
    inputs:
      database_file:
        description: 'æ•°æ®åº“æ–‡ä»¶è·¯å¾„'
        required: true
        default: 'database.sql'

jobs:
  deploy-database:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ” æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶
      run: |
        DB_FILE="${{ github.event.inputs.database_file || 'database.sql' }}"
        if [ ! -f "$DB_FILE" ]; then
          echo "âŒ æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨: $DB_FILE"
          exit 1
        fi
        echo "âœ… æ‰¾åˆ°æ•°æ®åº“æ–‡ä»¶: $DB_FILE"
        ls -la "$DB_FILE"

    - name: ğŸš€ éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        command_timeout: "600s"
        script: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²æ•°æ®åº“åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨..."
          echo "ğŸ“¦ æ•°æ®åº“æ–‡ä»¶: ${{ github.event.inputs.database_file || 'database.sql' }}"
          
          # æ£€æŸ¥ MySQL æ˜¯å¦å®‰è£…
          if ! command -v mysql &> /dev/null; then
            echo "ğŸ“¦ å®‰è£… MySQL..."
            sudo apt-get update
            sudo apt-get install -y mysql-server
            sudo systemctl start mysql
            sudo systemctl enable mysql
          else
            echo "âœ… MySQL å·²å®‰è£…"
            sudo systemctl start mysql || true
          fi
          
          # åˆ›å»ºæ•°æ®åº“ç”¨æˆ·ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          echo "ğŸ”§ é…ç½®æ•°æ®åº“ç”¨æˆ·..."
          sudo mysql -e "CREATE USER IF NOT EXISTS '${{ secrets.DB_USER }}'@'localhost' IDENTIFIED BY '${{ secrets.DB_PASSWORD }}';" || true
          sudo mysql -e "GRANT ALL PRIVILEGES ON *.* TO '${{ secrets.DB_USER }}'@'localhost' WITH GRANT OPTION;" || true
          sudo mysql -e "FLUSH PRIVILEGES;" || true
          
          # åˆ›å»ºæ•°æ®åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          echo "ğŸ“Š åˆ›å»ºæ•°æ®åº“..."
          sudo mysql -e "CREATE DATABASE IF NOT EXISTS \`${{ secrets.DB_NAME }}\`;" || true
          
          # å¤‡ä»½ç°æœ‰æ•°æ®åº“ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          echo "ğŸ“¦ å¤‡ä»½ç°æœ‰æ•°æ®åº“..."
          BACKUP_FILE="/tmp/backup_${{ secrets.DB_NAME }}_$(date +%Y%m%d_%H%M%S).sql"
          sudo mysqldump -u${{ secrets.DB_USER }} -p${{ secrets.DB_PASSWORD }} \`${{ secrets.DB_NAME }}\` > "$BACKUP_FILE" 2>/dev/null || echo "âš ï¸ å¤‡ä»½å¤±è´¥æˆ–æ•°æ®åº“ä¸ºç©º"
          
          # åˆ é™¤ç°æœ‰æ•°æ®åº“å†…å®¹
          echo "ğŸ—‘ï¸ æ¸…ç©ºç°æœ‰æ•°æ®åº“..."
          sudo mysql -u${{ secrets.DB_USER }} -p${{ secrets.DB_PASSWORD }} -e "DROP DATABASE IF EXISTS \`${{ secrets.DB_NAME }}\`;"
          sudo mysql -u${{ secrets.DB_USER }} -p${{ secrets.DB_PASSWORD }} -e "CREATE DATABASE \`${{ secrets.DB_NAME }}\`;"
          
          echo "âœ… æ•°æ®åº“å‡†å¤‡å®Œæˆ"

    - name: ğŸ“¤ ä¸Šä¼ æ•°æ®åº“æ–‡ä»¶
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        source: "${{ github.event.inputs.database_file || 'database.sql' }}"
        target: "/tmp/"

    - name: ğŸ”„ å¯¼å…¥æ•°æ®åº“
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        command_timeout: "600s"
        script: |
          echo "ğŸ“¥ å¯¼å…¥æ•°æ®åº“..."
          DB_FILE="/tmp/${{ github.event.inputs.database_file || 'database.sql' }}"
          
          # å¯¼å…¥æ•°æ®åº“
          sudo mysql -u${{ secrets.DB_USER }} -p${{ secrets.DB_PASSWORD }} \`${{ secrets.DB_NAME }}\` < "$DB_FILE"
          
          if [ $? -eq 0 ]; then
            echo "âœ… æ•°æ®åº“å¯¼å…¥æˆåŠŸï¼"
          else
            echo "âŒ æ•°æ®åº“å¯¼å…¥å¤±è´¥"
            exit 1
          fi
          
          # éªŒè¯å¯¼å…¥ç»“æœ
          echo "ğŸ” éªŒè¯æ•°æ®åº“..."
          TABLE_COUNT=$(sudo mysql -u${{ secrets.DB_USER }} -p${{ secrets.DB_PASSWORD }} -e "USE \`${{ secrets.DB_NAME }}\`; SHOW TABLES;" | wc -l)
          echo "ğŸ“Š æ•°æ®åº“è¡¨æ•°é‡: $((TABLE_COUNT - 1))"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f "$DB_FILE"
          
          echo "ğŸ‰ æ•°æ®åº“éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸŒ æ•°æ®åº“åœ°å€: ${{ secrets.ALIYUN_HOST }}:3306"
          echo "ğŸ“Š æ•°æ®åº“åç§°: ${{ secrets.DB_NAME }}"

    - name: ğŸ”„ é‡å¯åº”ç”¨ï¼ˆå¯é€‰ï¼‰
      uses: appleboy/ssh-action@v1.0.3
      if: ${{ secrets.RESTART_APP == 'true' }}
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        script: |
          echo "ğŸ”„ é‡å¯åº”ç”¨..."
          
          # é‡å¯ PM2 åº”ç”¨
          pm2 restart all || echo "PM2 æœªè¿è¡Œ"
          
          # é‡å¯ Docker å®¹å™¨
          docker-compose restart || docker compose restart || echo "Docker Compose æœªè¿è¡Œ"
          
          echo "âœ… åº”ç”¨é‡å¯å®Œæˆ" 