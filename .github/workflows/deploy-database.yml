name: ğŸš€ æ•°æ®åº“éƒ¨ç½²åˆ°é˜¿é‡Œäº‘

on:
  push:
    branches: [ main, master ]
    paths:
      - 'database.sql'
      - 'src/**'
      - '.github/workflows/deploy-database.yml'
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'éƒ¨ç½²ç±»å‹'
        required: true
        default: 'incremental'
        type: choice
        options:
          - incremental
          - full
      source_env:
        description: 'æºç¯å¢ƒ'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - test
          - staging
          - production
      target_env:
        description: 'ç›®æ ‡ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - development
          - test
          - staging
          - production
      database_file:
        description: 'æ•°æ®åº“æ–‡ä»¶è·¯å¾„ï¼ˆä»…ç”¨äºå®Œæ•´éƒ¨ç½²ï¼‰'
        required: false
        default: 'database.sql'

jobs:
  deploy-database:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm install

    - name: ğŸ” æ£€æŸ¥éƒ¨ç½²ç±»å‹
      run: |
        DEPLOY_TYPE="${{ github.event.inputs.deploy_type || 'incremental' }}"
        SOURCE_ENV="${{ github.event.inputs.source_env || 'development' }}"
        TARGET_ENV="${{ github.event.inputs.target_env || 'production' }}"
        
        echo "ğŸš€ éƒ¨ç½²ç±»å‹: $DEPLOY_TYPE"
        echo "ğŸ“¤ æºç¯å¢ƒ: $SOURCE_ENV"
        echo "ğŸ“¥ ç›®æ ‡ç¯å¢ƒ: $TARGET_ENV"
        
        if [ "$DEPLOY_TYPE" = "full" ]; then
          DB_FILE="${{ github.event.inputs.database_file || 'database.sql' }}"
          if [ ! -f "$DB_FILE" ]; then
            echo "âŒ æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨: $DB_FILE"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ°æ•°æ®åº“æ–‡ä»¶: $DB_FILE"
          ls -la "$DB_FILE"
        fi

    - name: ğŸš€ éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        command_timeout: "600s"
        script: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²æ•°æ®åº“åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨..."
          echo "ğŸ“¦ éƒ¨ç½²ç±»å‹: ${{ github.event.inputs.deploy_type || 'incremental' }}"
          echo "ğŸ“¤ æºç¯å¢ƒ: ${{ github.event.inputs.source_env || 'development' }}"
          echo "ğŸ“¥ ç›®æ ‡ç¯å¢ƒ: ${{ github.event.inputs.target_env || 'production' }}"
          
          # æ£€æŸ¥ Node.js æ˜¯å¦å®‰è£…
          if ! command -v node &> /dev/null; then
            echo "ğŸ“¦ å®‰è£… Node.js..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
          else
            echo "âœ… Node.js å·²å®‰è£…: $(node --version)"
          fi
          
          # æ£€æŸ¥ MySQL æ˜¯å¦å®‰è£…
          if ! command -v mysql &> /dev/null; then
            echo "ğŸ“¦ å®‰è£… MySQL..."
            sudo apt-get update
            sudo apt-get install -y mysql-server
            sudo systemctl start mysql
            sudo systemctl enable mysql
          else
            echo "âœ… MySQL å·²å®‰è£…"
            sudo systemctl start mysql || true
          fi
          
          # æ£€æŸ¥ MySQL æœåŠ¡çŠ¶æ€
          echo "ğŸ” MySQL æœåŠ¡çŠ¶æ€:"
          sudo systemctl status mysql --no-pager -l
          
          # åˆ›å»ºæ•°æ®åº“ç”¨æˆ·ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          echo "ğŸ”§ é…ç½®æ•°æ®åº“ç”¨æˆ·..."
          sudo mysql -e "CREATE USER IF NOT EXISTS ${{ secrets.DB_USER }}@localhost IDENTIFIED BY 'Zhengwenguo0503.';" || true
          sudo mysql -e "GRANT ALL PRIVILEGES ON *.* TO ${{ secrets.DB_USER }}@localhost WITH GRANT OPTION;" || true
          sudo mysql -e "FLUSH PRIVILEGES;" || true
          
          # åˆ›å»ºæ•°æ®åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          echo "ğŸ“Š åˆ›å»ºæ•°æ®åº“..."
          sudo mysql -e "CREATE DATABASE IF NOT EXISTS \`${{ secrets.DB_NAME }}\`;" || true
          
          # æ˜¾ç¤ºæ‰€æœ‰æ•°æ®åº“
          echo "ğŸ” å½“å‰æ‰€æœ‰æ•°æ®åº“:"
          sudo mysql -e "SHOW DATABASES;"
          
          echo "âœ… æ•°æ®åº“å‡†å¤‡å®Œæˆ"

    - name: ğŸ“¤ ä¸Šä¼ é¡¹ç›®æ–‡ä»¶
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        source: "./"
        target: "/tmp/"

    - name: ğŸ”„ æ‰§è¡Œéƒ¨ç½²
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        command_timeout: "600s"
        script: |
          echo "ğŸ”„ æ‰§è¡Œæ•°æ®åº“éƒ¨ç½²..."
          
          DEPLOY_TYPE="${{ github.event.inputs.deploy_type || 'incremental' }}"
          SOURCE_ENV="${{ github.event.inputs.source_env || 'development' }}"
          TARGET_ENV="${{ github.event.inputs.target_env || 'production' }}"
          
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd /tmp
          
          # å®‰è£…ä¾èµ–
          echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
          npm install
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export DB_HOST="localhost"
          export DB_USER="${{ secrets.DB_USER }}"
          export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export DB_NAME="${{ secrets.DB_NAME }}"
          
          # æ ¹æ®éƒ¨ç½²ç±»å‹æ‰§è¡Œä¸åŒçš„å‘½ä»¤
          if [ "$DEPLOY_TYPE" = "incremental" ]; then
            echo "ğŸ”„ æ‰§è¡Œå¢é‡éƒ¨ç½²: $SOURCE_ENV -> $TARGET_ENV"
            
            # åˆ›å»ºé…ç½®æ–‡ä»¶
            mkdir -p src
            echo "const configs = {" > src/db-config.js
            echo "  development: {" >> src/db-config.js
            echo "    host: process.env.DB_HOST || 'localhost'," >> src/db-config.js
            echo "    user: process.env.DB_USER || 'root'," >> src/db-config.js
            echo "    password: process.env.DB_PASSWORD || 'password'," >> src/db-config.js
            echo "    database: process.env.DB_NAME || 'nest_db'," >> src/db-config.js
            echo "    charset: 'utf8mb4'," >> src/db-config.js
            echo "    port: process.env.DB_PORT || 3306" >> src/db-config.js
            echo "  }," >> src/db-config.js
            echo "  test: {" >> src/db-config.js
            echo "    host: process.env.DB_HOST || 'localhost'," >> src/db-config.js
            echo "    user: process.env.DB_USER || 'root'," >> src/db-config.js
            echo "    password: process.env.DB_PASSWORD || 'password'," >> src/db-config.js
            echo "    database: process.env.DB_NAME || 'nest_db_test'," >> src/db-config.js
            echo "    charset: 'utf8mb4'," >> src/db-config.js
            echo "    port: process.env.DB_PORT || 3306" >> src/db-config.js
            echo "  }," >> src/db-config.js
            echo "  staging: {" >> src/db-config.js
            echo "    host: process.env.DB_HOST || 'localhost'," >> src/db-config.js
            echo "    user: process.env.DB_USER || 'root'," >> src/db-config.js
            echo "    password: process.env.DB_PASSWORD || 'password'," >> src/db-config.js
            echo "    database: process.env.DB_NAME || 'nest_db_staging'," >> src/db-config.js
            echo "    charset: 'utf8mb4'," >> src/db-config.js
            echo "    port: process.env.DB_PORT || 3306" >> src/db-config.js
            echo "  }," >> src/db-config.js
            echo "  production: {" >> src/db-config.js
            echo "    host: process.env.DB_HOST || 'localhost'," >> src/db-config.js
            echo "    user: process.env.DB_USER || 'root'," >> src/db-config.js
            echo "    password: process.env.DB_PASSWORD || 'password'," >> src/db-config.js
            echo "    database: process.env.DB_NAME || 'nest_db_prod'," >> src/db-config.js
            echo "    charset: 'utf8mb4'," >> src/db-config.js
            echo "    port: process.env.DB_PORT || 3306" >> src/db-config.js
            echo "  }" >> src/db-config.js
            echo "};" >> src/db-config.js
            echo "" >> src/db-config.js
            echo "function getConfig(environment = 'development') {" >> src/db-config.js
            echo "  const config = configs[environment];" >> src/db-config.js
            echo "  if (!config) {" >> src/db-config.js
            echo "    throw new Error(\`æœªçŸ¥çš„ç¯å¢ƒé…ç½®: \${environment}\`);" >> src/db-config.js
            echo "  }" >> src/db-config.js
            echo "  return config;" >> src/db-config.js
            echo "}" >> src/db-config.js
            echo "" >> src/db-config.js
            echo "function getAvailableEnvironments() {" >> src/db-config.js
            echo "  return Object.keys(configs);" >> src/db-config.js
            echo "}" >> src/db-config.js
            echo "" >> src/db-config.js
            echo "function validateConfig(config) {" >> src/db-config.js
            echo "  const required = ['host', 'user', 'password', 'database'];" >> src/db-config.js
            echo "  for (const field of required) {" >> src/db-config.js
            echo "    if (!config[field]) {" >> src/db-config.js
            echo "      throw new Error(\`ç¼ºå°‘å¿…éœ€çš„é…ç½®å­—æ®µ: \${field}\`);" >> src/db-config.js
            echo "    }" >> src/db-config.js
            echo "  }" >> src/db-config.js
            echo "  return true;" >> src/db-config.js
            echo "}" >> src/db-config.js
            echo "" >> src/db-config.js
            echo "module.exports = {" >> src/db-config.js
            echo "  getConfig," >> src/db-config.js
            echo "  getAvailableEnvironments," >> src/db-config.js
            echo "  validateConfig," >> src/db-config.js
            echo "  configs" >> src/db-config.js
            echo "};" >> src/db-config.js
            
            # æ‰§è¡Œå¢é‡éƒ¨ç½²
            node src/incremental-deploy.js "$SOURCE_ENV" "$TARGET_ENV" --execute
            
          elif [ "$DEPLOY_TYPE" = "full" ]; then
            echo "ğŸ”„ æ‰§è¡Œå®Œæ•´éƒ¨ç½²: $SOURCE_ENV -> $TARGET_ENV"
            
            # ä¸Šä¼ æ•°æ®åº“æ–‡ä»¶ï¼ˆå¦‚æœæŒ‡å®šï¼‰
            DB_FILE="${{ github.event.inputs.database_file || 'database.sql' }}"
            if [ -f "/tmp/$DB_FILE" ]; then
              echo "ğŸ“¤ ä½¿ç”¨æŒ‡å®šçš„æ•°æ®åº“æ–‡ä»¶: $DB_FILE"
              cp "/tmp/$DB_FILE" .
            else
              echo "ğŸ“¤ å¯¼å‡ºæºæ•°æ®åº“..."
              node src/export.js export -o database.sql
            fi
            
            # æ‰§è¡Œå®Œæ•´éƒ¨ç½²
            chmod +x deploy.sh
            ./deploy.sh full "$SOURCE_ENV" "$TARGET_ENV" -f
            
          else
            echo "âŒ æœªçŸ¥çš„éƒ¨ç½²ç±»å‹: $DEPLOY_TYPE"
            exit 1
          fi
          
          # éªŒè¯éƒ¨ç½²ç»“æœ
          echo "ğŸ” éªŒè¯éƒ¨ç½²ç»“æœ..."
          node -e "
            const mysql = require('mysql2/promise');
            const config = {
              host: process.env.DB_HOST || 'localhost',
              user: process.env.DB_USER || 'root',
              password: process.env.DB_PASSWORD || 'password',
              database: process.env.DB_NAME || 'nest_db',
              charset: 'utf8mb4'
            };
            
            mysql.createConnection(config)
              .then(connection => {
                return connection.execute('SHOW TABLES')
                  .then(([rows]) => {
                    console.log('ğŸ“Š æ•°æ®åº“è¡¨æ•°é‡:', rows.length);
                    console.log('ğŸ“‹ è¡¨åˆ—è¡¨:');
                    rows.forEach(row => {
                      console.log('  -', Object.values(row)[0]);
                    });
                    return connection.end();
                  });
              })
              .catch(error => {
                console.error('âŒ éªŒè¯å¤±è´¥:', error.message);
                process.exit(1);
              });
          "
          
          echo "ğŸ‰ æ•°æ®åº“éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸŒ æ•°æ®åº“åœ°å€: ${{ secrets.ALIYUN_HOST }}:3306"
          echo "ğŸ“Š æ•°æ®åº“åç§°: ${{ secrets.DB_NAME }}"
          echo "ğŸ”§ éƒ¨ç½²ç±»å‹: $DEPLOY_TYPE"

    - name: ğŸ”„ é‡å¯åº”ç”¨
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        script: |
          echo "ğŸ”„ æ£€æŸ¥æ˜¯å¦éœ€è¦é‡å¯åº”ç”¨..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰åº”ç”¨éœ€è¦é‡å¯
          if command -v pm2 &> /dev/null; then
            echo "ğŸ”„ é‡å¯ PM2 åº”ç”¨..."
            pm2 restart all || echo "PM2 é‡å¯å¤±è´¥æˆ–æ— åº”ç”¨è¿è¡Œ"
          fi
          
          if command -v docker-compose &> /dev/null || command -v docker &> /dev/null; then
            echo "ğŸ”„ é‡å¯ Docker å®¹å™¨..."
            docker-compose restart 2>/dev/null || docker compose restart 2>/dev/null || echo "Docker Compose é‡å¯å¤±è´¥æˆ–æ— å®¹å™¨è¿è¡Œ"
          fi
          
          echo "âœ… åº”ç”¨é‡å¯æ£€æŸ¥å®Œæˆ"

    - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        script: |
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -rf /tmp/*
          echo "âœ… æ¸…ç†å®Œæˆ" 