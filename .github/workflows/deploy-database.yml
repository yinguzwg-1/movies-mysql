name: ğŸš€ æ•°æ®åº“éƒ¨ç½²åˆ°é˜¿é‡Œäº‘

on:
  push:
    branches: [ main, master ]
    paths:
      - 'database.sql'
      - '.github/workflows/deploy-database.yml'
  workflow_dispatch:
    inputs:
      database_file:
        description: 'æ•°æ®åº“æ–‡ä»¶è·¯å¾„'
        required: true
        default: 'database.sql'

jobs:
  deploy-database:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ” æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶
      run: |
        DB_FILE="${{ github.event.inputs.database_file || 'database.sql' }}"
        if [ ! -f "$DB_FILE" ]; then
          echo "âŒ æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨: $DB_FILE"
          exit 1
        fi
        echo "âœ… æ‰¾åˆ°æ•°æ®åº“æ–‡ä»¶: $DB_FILE"
        ls -la "$DB_FILE"

    - name: ğŸš€ éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        command_timeout: "600s"
        script: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²æ•°æ®åº“åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨..."
          echo "ğŸ“¦ æ•°æ®åº“æ–‡ä»¶: ${{ github.event.inputs.database_file || 'database.sql' }}"
          echo "ğŸ” è°ƒè¯•ä¿¡æ¯å¼€å§‹ ========================"
          echo "æ•°æ®åº“åç§°: '${{ secrets.DB_NAME }}'"
          echo "æ•°æ®åº“ç”¨æˆ·: '${{ secrets.DB_USER }}'"
          echo "æ•°æ®åº“å¯†ç é•¿åº¦: ${#DB_PASSWORD} å­—ç¬¦"
          echo "=========================================="
          
          # æ£€æŸ¥ MySQL æ˜¯å¦å®‰è£…
          if ! command -v mysql &> /dev/null; then
            echo "ğŸ“¦ å®‰è£… MySQL..."
            sudo apt-get update
            sudo apt-get install -y mysql-server
            sudo systemctl start mysql
            sudo systemctl enable mysql
          else
            echo "âœ… MySQL å·²å®‰è£…"
            sudo systemctl start mysql || true
          fi
          
          # æ£€æŸ¥ MySQL æœåŠ¡çŠ¶æ€
          echo "ğŸ” MySQL æœåŠ¡çŠ¶æ€:"
          sudo systemctl status mysql --no-pager -l
          
          # åˆ›å»ºæ•°æ®åº“ç”¨æˆ·ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          echo "ğŸ”§ é…ç½®æ•°æ®åº“ç”¨æˆ·..."
          sudo mysql -e "CREATE USER IF NOT EXISTS '${{ secrets.DB_USER }}'@'localhost' IDENTIFIED BY '${{ secrets.DB_PASSWORD }}';" || true
          sudo mysql -e "GRANT ALL PRIVILEGES ON *.* TO '${{ secrets.DB_USER }}'@'localhost' WITH GRANT OPTION;" || true
          sudo mysql -e "FLUSH PRIVILEGES;" || true
          
          # åˆ›å»ºæ•°æ®åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          echo "ğŸ“Š åˆ›å»ºæ•°æ®åº“..."
          sudo mysql -e "CREATE DATABASE IF NOT EXISTS \`${{ secrets.DB_NAME }}\`;" || true
          
          # æ˜¾ç¤ºæ‰€æœ‰æ•°æ®åº“
          echo "ğŸ” å½“å‰æ‰€æœ‰æ•°æ®åº“:"
          sudo mysql -e "SHOW DATABASES;"
          
          # åˆ›å»ºé…ç½®æ–‡ä»¶æ¥é¿å…å¯†ç åœ¨å‘½ä»¤è¡Œä¸­æ˜¾ç¤º
          MYSQL_CNF="/tmp/mysql.cnf"
          cat > "$MYSQL_CNF" << EOF
          [client]
          user=${{ secrets.DB_USER }}
          password=${{ secrets.DB_PASSWORD }}
          host=localhost
          port=3306
          EOF
          
          echo "ğŸ” é…ç½®æ–‡ä»¶å†…å®¹ï¼ˆéšè—å¯†ç ï¼‰:"
          cat "$MYSQL_CNF" | sed 's/password=.*/password=***HIDDEN***/'
          
          # è®¾ç½®é…ç½®æ–‡ä»¶æƒé™
          chmod 600 "$MYSQL_CNF"
          
          # æµ‹è¯•æ•°æ®åº“è¿æ¥
          echo "ğŸ” æµ‹è¯•æ•°æ®åº“è¿æ¥..."
          if sudo mysql --defaults-extra-file="$MYSQL_CNF" -e "SELECT 1;" > /dev/null 2>&1; then
            echo "âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ"
          else
            echo "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥"
            echo "ğŸ” å°è¯•æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯:"
            sudo mysql --defaults-extra-file="$MYSQL_CNF" -e "SELECT 1;" 2>&1
            rm -f "$MYSQL_CNF"
            exit 1
          fi
          
          # å¤‡ä»½ç°æœ‰æ•°æ®åº“ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          echo "ğŸ“¦ å¤‡ä»½ç°æœ‰æ•°æ®åº“..."
          BACKUP_FILE="/tmp/backup_${{ secrets.DB_NAME }}_$(date +%Y%m%d_%H%M%S).sql"
          sudo mysqldump --defaults-extra-file="$MYSQL_CNF" \`${{ secrets.DB_NAME }}\` > "$BACKUP_FILE" 2>/dev/null || echo "âš ï¸ å¤‡ä»½å¤±è´¥æˆ–æ•°æ®åº“ä¸ºç©º"
          
          # åˆ é™¤ç°æœ‰æ•°æ®åº“å†…å®¹
          echo "ğŸ—‘ï¸ æ¸…ç©ºç°æœ‰æ•°æ®åº“..."
          sudo mysql --defaults-extra-file="$MYSQL_CNF" -e "DROP DATABASE IF EXISTS \`${{ secrets.DB_NAME }}\`;"
          sudo mysql --defaults-extra-file="$MYSQL_CNF" -e "CREATE DATABASE \`${{ secrets.DB_NAME }}\`;"
          
          # æ¸…ç†é…ç½®æ–‡ä»¶
          rm -f "$MYSQL_CNF"
          
          echo "âœ… æ•°æ®åº“å‡†å¤‡å®Œæˆ"
          echo "ğŸ” è°ƒè¯•ä¿¡æ¯ç»“æŸ ========================"

    - name: ğŸ“¤ ä¸Šä¼ æ•°æ®åº“æ–‡ä»¶
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        source: "${{ github.event.inputs.database_file || 'database.sql' }}"
        target: "/tmp/"

    - name: ğŸ”„ å¯¼å…¥æ•°æ®åº“
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        command_timeout: "600s"
        script: |
          echo "ğŸ“¥ å¯¼å…¥æ•°æ®åº“..."
          echo "ğŸ” è°ƒè¯•ä¿¡æ¯å¼€å§‹ ========================"
          echo "æ•°æ®åº“æ–‡ä»¶: /tmp/${{ github.event.inputs.database_file || 'database.sql' }}"
          echo "æ•°æ®åº“åç§°: '${{ secrets.DB_NAME }}'"
          echo "æ•°æ®åº“ç”¨æˆ·: '${{ secrets.DB_USER }}'"
          echo "æ•°æ®åº“å¯†ç é•¿åº¦: ${#DB_PASSWORD} å­—ç¬¦"
          echo "=========================================="
          
          DB_FILE="/tmp/${{ github.event.inputs.database_file || 'database.sql' }}"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$DB_FILE" ]; then
            echo "âŒ æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨: $DB_FILE"
            exit 1
          fi
          
          echo "âœ… æ•°æ®åº“æ–‡ä»¶å­˜åœ¨ï¼Œå¤§å°: $(ls -lh "$DB_FILE" | awk '{print $5}')"
          
          # åˆ›å»ºé…ç½®æ–‡ä»¶æ¥é¿å…å¯†ç åœ¨å‘½ä»¤è¡Œä¸­æ˜¾ç¤º
          MYSQL_CNF="/tmp/mysql.cnf"
          cat > "$MYSQL_CNF" << EOF
          [client]
          user=${{ secrets.DB_USER }}
          password=${{ secrets.DB_PASSWORD }}
          host=localhost
          port=3306
          EOF
          
          echo "ğŸ” é…ç½®æ–‡ä»¶å†…å®¹ï¼ˆéšè—å¯†ç ï¼‰:"
          cat "$MYSQL_CNF" | sed 's/password=.*/password=***HIDDEN***/'
          
          # è®¾ç½®é…ç½®æ–‡ä»¶æƒé™
          chmod 600 "$MYSQL_CNF"
          echo "âœ… é…ç½®æ–‡ä»¶æƒé™è®¾ç½®å®Œæˆ"
          
          # æµ‹è¯•æ•°æ®åº“è¿æ¥
          echo "ğŸ” æµ‹è¯•æ•°æ®åº“è¿æ¥..."
          if sudo mysql --defaults-extra-file="$MYSQL_CNF" -e "SELECT 1;" > /dev/null 2>&1; then
            echo "âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ"
          else
            echo "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥"
            echo "ğŸ” å°è¯•æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯:"
            sudo mysql --defaults-extra-file="$MYSQL_CNF" -e "SELECT 1;" 2>&1
            rm -f "$MYSQL_CNF"
            exit 1
          fi
          
          # æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨
          echo "ğŸ” æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨..."
          DB_EXISTS=$(sudo mysql --defaults-extra-file="$MYSQL_CNF" -e "SHOW DATABASES LIKE '${{ secrets.DB_NAME }}';" 2>/dev/null | wc -l)
          if [ "$DB_EXISTS" -gt 1 ]; then
            echo "âœ… æ•°æ®åº“ '${{ secrets.DB_NAME }}' å·²å­˜åœ¨"
          else
            echo "âš ï¸ æ•°æ®åº“ '${{ secrets.DB_NAME }}' ä¸å­˜åœ¨ï¼Œå°†åˆ›å»º"
            sudo mysql --defaults-extra-file="$MYSQL_CNF" -e "CREATE DATABASE \`${{ secrets.DB_NAME }}\`;"
          fi
          
          # æ˜¾ç¤ºæ‰€æœ‰æ•°æ®åº“
          echo "ğŸ” å½“å‰æ‰€æœ‰æ•°æ®åº“:"
          sudo mysql --defaults-extra-file="$MYSQL_CNF" -e "SHOW DATABASES;"
          
          # ä½¿ç”¨é…ç½®æ–‡ä»¶å¯¼å…¥æ•°æ®åº“
          echo "ğŸ“¥ å¼€å§‹å¯¼å…¥æ•°æ®åº“åˆ° '${{ secrets.DB_NAME }}'..."
          sudo mysql --defaults-extra-file="$MYSQL_CNF" \`${{ secrets.DB_NAME }}\` < "$DB_FILE"
          
          if [ $? -eq 0 ]; then
            echo "âœ… æ•°æ®åº“å¯¼å…¥æˆåŠŸï¼"
          else
            echo "âŒ æ•°æ®åº“å¯¼å…¥å¤±è´¥"
            echo "ğŸ” å¯¼å…¥é”™è¯¯è¯¦æƒ…:"
            sudo mysql --defaults-extra-file="$MYSQL_CNF" \`${{ secrets.DB_NAME }}\` < "$DB_FILE" 2>&1
            # æ¸…ç†é…ç½®æ–‡ä»¶
            rm -f "$MYSQL_CNF"
            exit 1
          fi
          
          # éªŒè¯å¯¼å…¥ç»“æœ
          echo "ğŸ” éªŒè¯æ•°æ®åº“..."
          TABLE_COUNT=$(sudo mysql --defaults-extra-file="$MYSQL_CNF" -e "USE \`${{ secrets.DB_NAME }}\`; SHOW TABLES;" | wc -l)
          echo "ğŸ“Š æ•°æ®åº“è¡¨æ•°é‡: $((TABLE_COUNT - 1))"
          
          echo "ğŸ” æ•°æ®åº“ä¸­çš„è¡¨:"
          sudo mysql --defaults-extra-file="$MYSQL_CNF" -e "USE \`${{ secrets.DB_NAME }}\`; SHOW TABLES;"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f "$DB_FILE" "$MYSQL_CNF"
          
          echo "ğŸ‰ æ•°æ®åº“éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸŒ æ•°æ®åº“åœ°å€: ${{ secrets.ALIYUN_HOST }}:3306"
          echo "ğŸ“Š æ•°æ®åº“åç§°: ${{ secrets.DB_NAME }}"
          echo "ğŸ” è°ƒè¯•ä¿¡æ¯ç»“æŸ ========================"

    - name: ğŸ”„ é‡å¯åº”ç”¨
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        script: |
          echo "ğŸ”„ æ£€æŸ¥æ˜¯å¦éœ€è¦é‡å¯åº”ç”¨..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰åº”ç”¨éœ€è¦é‡å¯
          if command -v pm2 &> /dev/null; then
            echo "ğŸ”„ é‡å¯ PM2 åº”ç”¨..."
            pm2 restart all || echo "PM2 é‡å¯å¤±è´¥æˆ–æ— åº”ç”¨è¿è¡Œ"
          fi
          
          if command -v docker-compose &> /dev/null || command -v docker &> /dev/null; then
            echo "ğŸ”„ é‡å¯ Docker å®¹å™¨..."
            docker-compose restart 2>/dev/null || docker compose restart 2>/dev/null || echo "Docker Compose é‡å¯å¤±è´¥æˆ–æ— å®¹å™¨è¿è¡Œ"
          fi
          
          echo "âœ… åº”ç”¨é‡å¯æ£€æŸ¥å®Œæˆ" 