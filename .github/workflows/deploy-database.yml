name: ğŸš€ æ•°æ®åº“éƒ¨ç½²

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - '.github/workflows/deploy-database.yml'
      - '.env'
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'éƒ¨ç½²ç±»å‹'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - incremental
      auto_execute:
        description: 'æ˜¯å¦è‡ªåŠ¨æ‰§è¡Œéƒ¨ç½²'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      output_file:
        description: 'è¾“å‡ºSQLæ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''

jobs:
  deploy-database:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm install

    - name: ğŸ” æ£€æŸ¥éƒ¨ç½²é…ç½®
      run: |
        DEPLOY_TYPE="${{ github.event.inputs.deploy_type || 'full' }}"
        AUTO_EXECUTE="${{ github.event.inputs.auto_execute || 'true' }}"
        OUTPUT_FILE="${{ github.event.inputs.output_file || '' }}"
        
        echo "ğŸš€ éƒ¨ç½²é…ç½®:"
        echo "ğŸ“¤ éƒ¨ç½²ç±»å‹: $DEPLOY_TYPE"
        echo "ğŸ“¤ è‡ªåŠ¨æ‰§è¡Œ: $AUTO_EXECUTE"
        if [ -n "$OUTPUT_FILE" ]; then
          echo "ğŸ“¥ è¾“å‡ºæ–‡ä»¶: $OUTPUT_FILE"
        fi

    - name: ğŸš€ éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        command_timeout: "600s"
        script: |
          echo "ğŸš€ å¼€å§‹å¢é‡éƒ¨ç½²æ•°æ®åº“åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨..."
          
          # æ£€æŸ¥ Node.js æ˜¯å¦å®‰è£…
          if ! command -v node &> /dev/null; then
            echo "ğŸ“¦ å®‰è£… Node.js..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
          else
            echo "âœ… Node.js å·²å®‰è£…: $(node --version)"
          fi
          
          # æ£€æŸ¥ MySQL æ˜¯å¦å®‰è£…
          if ! command -v mysql &> /dev/null; then
            echo "ğŸ“¦ å®‰è£… MySQL..."
            sudo apt-get update
            sudo apt-get install -y mysql-server
            sudo systemctl start mysql
            sudo systemctl enable mysql
          else
            echo "âœ… MySQL å·²å®‰è£…"
            sudo systemctl start mysql || true
          fi
          
          # æ£€æŸ¥ MySQL æœåŠ¡çŠ¶æ€
          echo "ğŸ” MySQL æœåŠ¡çŠ¶æ€:"
          sudo systemctl status mysql --no-pager -l
          
          echo "âœ… æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡å®Œæˆ"

    - name: ğŸ“¤ ä¸Šä¼ é¡¹ç›®æ–‡ä»¶
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        source: "./"
        target: "/tmp/"

    - name: ğŸ”„ æ‰§è¡Œéƒ¨ç½²
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        command_timeout: "600s"
        script: |
          echo "ğŸ”„ æ‰§è¡Œéƒ¨ç½²..."
          
          DEPLOY_TYPE="${{ github.event.inputs.deploy_type || 'full' }}"
          AUTO_EXECUTE="${{ github.event.inputs.auto_execute || 'true' }}"
          OUTPUT_FILE="${{ github.event.inputs.output_file || '' }}"
          
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd /tmp
          
          # å®‰è£…ä¾èµ–
          echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
          npm install
          
          # ä½¿ç”¨GitHub Secretsé…ç½®æ•°æ®åº“è¿æ¥
          echo "ğŸ” ä½¿ç”¨GitHub Secretsé…ç½®æ•°æ®åº“è¿æ¥"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export DB_HOST="${{ secrets.DB_HOST }}"
          export DB_USER="${{ secrets.DB_USER }}"
          export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export DB_NAME="${{ secrets.DB_NAME }}"
          export DB_PORT="${{ secrets.DB_PORT || '3306' }}"
          
          # æ£€æŸ¥å¿…è¦çš„ç¯å¢ƒå˜é‡æ˜¯å¦è®¾ç½®
          if [ -z "$DB_HOST" ] || [ -z "$DB_USER" ] || [ -z "$DB_NAME" ]; then
            echo "âŒ é”™è¯¯ï¼šç¼ºå°‘å¿…è¦çš„æ•°æ®åº“é…ç½®"
            echo "è¯·ç¡®ä¿åœ¨GitHub Secretsä¸­é…ç½®äº†ä»¥ä¸‹å˜é‡ï¼š"
            echo "  - DB_HOST"
            echo "  - DB_USER" 
            echo "  - DB_NAME"
            exit 1
          fi
          
          echo "ğŸ” ç¯å¢ƒå˜é‡æ£€æŸ¥:"
          echo "   DB_HOST: $DB_HOST"
          echo "   DB_USER: $DB_USER"
          echo "   DB_PASSWORD: $DB_PASSWORD"
          echo "   DB_NAME: $DB_NAME"
          echo "   DB_PORT: $DB_PORT"
          
          # æ ¹æ®éƒ¨ç½²ç±»å‹æ‰§è¡Œä¸åŒçš„å‘½ä»¤
          if [ "$DEPLOY_TYPE" = "full" ]; then
            echo "ğŸ”„ æ‰§è¡Œå®Œæ•´éƒ¨ç½²..."
            
            # æ£€æŸ¥database.sqlæ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ -f "database.sql" ]; then
              echo "âœ… æ‰¾åˆ°database.sqlæ–‡ä»¶ï¼Œæ‰§è¡Œå®Œæ•´éƒ¨ç½²"
              
              # ä½¿ç”¨ Node.js è„šæœ¬å¤„ç† SQL æ–‡ä»¶
              echo "ğŸ“ å¤„ç† SQL æ–‡ä»¶ä»¥æ”¯æŒå·²å­˜åœ¨çš„è¡¨..."
              node src/process-sql.js database.sql database_safe.sql
              
              if [ $? -eq 0 ]; then
                echo "âœ… SQL æ–‡ä»¶å¤„ç†æˆåŠŸ"
                
                # æ‰§è¡Œå¤„ç†åçš„SQLæ–‡ä»¶
                mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASSWORD" -P "$DB_PORT" "$DB_NAME" < database_safe.sql
                
                if [ $? -eq 0 ]; then
                  echo "âœ… å®Œæ•´éƒ¨ç½²æ‰§è¡ŒæˆåŠŸ"
                  echo "ğŸ“Š å·²ä½¿ç”¨ IF NOT EXISTS å’Œ IGNORE é€‰é¡¹å¤„ç†é‡å¤è¡¨å’Œæ•°æ®"
                else
                  echo "âŒ å®Œæ•´éƒ¨ç½²æ‰§è¡Œå¤±è´¥"
                  exit 1
                fi
              else
                echo "âŒ SQL æ–‡ä»¶å¤„ç†å¤±è´¥"
                exit 1
              fi
              
              # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
              rm -f database_safe.sql
            else
              echo "âŒ æœªæ‰¾åˆ°database.sqlæ–‡ä»¶"
              exit 1
            fi
            
          else
            echo "ğŸ”„ æ‰§è¡Œå¢é‡éƒ¨ç½²..."
            
            # æ„å»ºå¢é‡éƒ¨ç½²å‘½ä»¤
            # æ¯”è¾ƒ database.sql æ–‡ä»¶ä¸ç”Ÿäº§æ•°æ®åº“çš„å·®å¼‚
            DEPLOY_CMD="node src/incremental-deploy.js production database.sql"
            
            if [ "$AUTO_EXECUTE" = "true" ]; then
              DEPLOY_CMD="$DEPLOY_CMD --execute"
            fi
            
            if [ -n "$OUTPUT_FILE" ]; then
              DEPLOY_CMD="$DEPLOY_CMD -o $OUTPUT_FILE"
            fi
            
            echo "ğŸš€ æ‰§è¡Œå‘½ä»¤: $DEPLOY_CMD"
            $DEPLOY_CMD
          fi
          
          # æ£€æŸ¥éƒ¨ç½²ç»“æœ
          if [ $? -ne 0 ]; then
            echo "âŒ å¢é‡éƒ¨ç½²æ‰§è¡Œå¤±è´¥"
            exit 1
          fi
          
          echo "âœ… å¢é‡éƒ¨ç½²æ‰§è¡ŒæˆåŠŸ"
          
          # éªŒè¯éƒ¨ç½²ç»“æœ
          echo "ğŸ” éªŒè¯éƒ¨ç½²ç»“æœ..."
          node -e "
            const mysql = require('mysql2/promise');
            
            const config = {
              host: '$DB_HOST',
              user: '$DB_USER',
              password: '$DB_PASSWORD',
              database: '$DB_NAME',
              charset: 'utf8mb4',
              port: $DB_PORT
            };
            
            mysql.createConnection(config)
              .then(connection => {
                return connection.execute('SHOW TABLES')
                  .then(([rows]) => {
                    console.log('ğŸ“Š æ•°æ®åº“è¡¨æ•°é‡:', rows.length);
                    console.log('ğŸ“‹ è¡¨åˆ—è¡¨:');
                    rows.forEach(row => {
                      console.log('  -', Object.values(row)[0]);
                    });
                    return connection.end();
                  });
              })
              .catch(error => {
                console.error('âŒ éªŒè¯å¤±è´¥:', error.message);
                process.exit(1);
              });
          "
          
          echo "ğŸ‰ å¢é‡éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸŒ æ•°æ®åº“åœ°å€: $DB_HOST:$DB_PORT"
          echo "ğŸ“Š æ•°æ®åº“åç§°: $DB_NAME"
          echo "ğŸ”§ éƒ¨ç½²ç±»å‹: incremental"

    - name: ğŸ”„ é‡å¯åº”ç”¨
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        script: |
          echo "ğŸ”„ æ£€æŸ¥æ˜¯å¦éœ€è¦é‡å¯åº”ç”¨..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰åº”ç”¨éœ€è¦é‡å¯
          if command -v pm2 &> /dev/null; then
            echo "ğŸ”„ é‡å¯ PM2 åº”ç”¨..."
            pm2 restart all || echo "PM2 é‡å¯å¤±è´¥æˆ–æ— åº”ç”¨è¿è¡Œ"
          fi
          
          if command -v docker-compose &> /dev/null || command -v docker &> /dev/null; then
            echo "ğŸ”„ é‡å¯ Docker å®¹å™¨..."
            docker-compose restart 2>/dev/null || docker compose restart 2>/dev/null || echo "Docker Compose é‡å¯å¤±è´¥æˆ–æ— å®¹å™¨è¿è¡Œ"
          fi
          
          echo "âœ… åº”ç”¨é‡å¯æ£€æŸ¥å®Œæˆ"

    - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        script: |
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -rf /tmp/*
          echo "âœ… æ¸…ç†å®Œæˆ" 