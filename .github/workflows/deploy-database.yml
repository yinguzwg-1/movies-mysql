name: ğŸš€ æ•°æ®åº“éƒ¨ç½²

on:
  push:
    branches: [main, master]
    paths:
      - 'src/**'
      - '.github/workflows/deploy-database.yml'
      - '.env'
  workflow_dispatch:
    inputs:
      auto_execute:
        description: 'æ˜¯å¦è‡ªåŠ¨æ‰§è¡Œéƒ¨ç½²'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      output_file:
        description: 'è¾“å‡ºSQLæ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''

jobs:
  deploy-database:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # è®¾ç½®æ•´ä¸ªjobçš„è¶…æ—¶æ—¶é—´
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm install

    - name: ğŸ” æ£€æŸ¥éƒ¨ç½²é…ç½®
      run: |
        AUTO_EXECUTE="${{ github.event.inputs.auto_execute || 'true' }}"
        OUTPUT_FILE="${{ github.event.inputs.output_file || '' }}"
        
        echo "ğŸš€ å¢é‡éƒ¨ç½²é…ç½®:"
        echo "ğŸ“¤ è‡ªåŠ¨æ‰§è¡Œ: $AUTO_EXECUTE"
        if [ -n "$OUTPUT_FILE" ]; then
          echo "ğŸ“¥ è¾“å‡ºæ–‡ä»¶: $OUTPUT_FILE"
        fi

    - name: ğŸš€ å‡†å¤‡æœåŠ¡å™¨ç¯å¢ƒ
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        command_timeout: "1200s"  # 20åˆ†é’Ÿ
        script: |
          echo "ğŸ› ï¸ å¼€å§‹å‡†å¤‡æœåŠ¡å™¨ç¯å¢ƒ..."
          
          # 1. ç¡®ä¿MySQLå¯è¿œç¨‹è®¿é—®
          sudo mysql -e "CREATE USER IF NOT EXISTS 'deploy_user'@'%' IDENTIFIED WITH mysql_native_password BY '${{ secrets.DB_PASSWORD }}';"
          sudo mysql -e "GRANT ALL PRIVILEGES ON *.* TO 'deploy_user'@'%';"
          sudo mysql -e "FLUSH PRIVILEGES;"
          
          # 2. ä¿®æ”¹MySQLé…ç½®
          sudo sed -i 's/^bind-address.*/bind-address = 0.0.0.0/' /etc/mysql/mysql.conf.d/mysqld.cnf
          sudo sed -i '/^skip-networking/d' /etc/mysql/mysql.conf.d/mysqld.cnf
          
          # 3. å¼€æ”¾é˜²ç«å¢™
          sudo ufw allow 3306/tcp || true
          sudo systemctl restart mysql
          
          # 4. éªŒè¯MySQLè¿æ¥
          mysql -h 127.0.0.1 -u deploy_user -p'${{ secrets.DB_PASSWORD }}' -e "SELECT 1" || {
            echo "âŒ MySQLæœ¬åœ°è¿æ¥æµ‹è¯•å¤±è´¥";
            sudo tail -n 50 /var/log/mysql/error.log;
            exit 1;
          }

    - name: ğŸ“¦ å‹ç¼©é¡¹ç›®æ–‡ä»¶
      run: |
        echo "ğŸ—œï¸ å‹ç¼©é¡¹ç›®æ–‡ä»¶..."
        tar --exclude='./node_modules' -czvf deploy.tar.gz .
        ls -lh deploy.tar.gz

    - name: ğŸ“¤ ä¸Šä¼ é¡¹ç›®æ–‡ä»¶
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        source: "deploy.tar.gz"
        target: "/tmp/"
        overwrite: true

    - name: ğŸ”„ æ‰§è¡Œå¢é‡éƒ¨ç½²
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        command_timeout: "1800s"  # 30åˆ†é’Ÿ
        script: |
          set -e  # ä»»ä½•é”™è¯¯ç«‹å³é€€å‡º
          echo "ğŸ”„ å¼€å§‹å¢é‡éƒ¨ç½²..."
          
          # 1. è§£å‹é¡¹ç›®æ–‡ä»¶
          cd /tmp
          tar -xzvf deploy.tar.gz
          
          # 2. å®‰è£…ç”Ÿäº§ä¾èµ–ï¼ˆå¿½ç•¥devDependenciesï¼‰
          npm install --production
          
          # 3. åŠ è½½ç¯å¢ƒå˜é‡
          export $(grep -v '^#' .env | xargs)
          
          # 4. å¸¦é‡è¯•æœºåˆ¶çš„éƒ¨ç½²
          for attempt in {1..3}; do
            echo "ğŸ”„ å°è¯• $attempt/3..."
            if node src/incremental-deploy.js \
              --host "$DB_HOST" \
              --user "deploy_user" \
              --password "$DB_PASSWORD" \
              --database "$DB_NAME" \
              --port "$DB_PORT" \
              $([[ "${{ github.event.inputs.auto_execute }}" == "true" ]] && echo "--execute") \
              $([[ -n "${{ github.event.inputs.output_file }}" ]] && echo "-o ${{ github.event.inputs.output_file }}"); then
              echo "âœ… éƒ¨ç½²æˆåŠŸ"
              break
            else
              echo "âš ï¸ å°è¯• $attempt å¤±è´¥"
              sleep 10
              if [ $attempt -eq 3 ]; then
                echo "âŒ æ‰€æœ‰é‡è¯•å‡å¤±è´¥"
                exit 1
              fi
            fi
          done
          
          # 5. éªŒè¯éƒ¨ç½²ç»“æœ
          echo "ğŸ” éªŒè¯æ•°æ®åº“å˜æ›´..."
          mysql -h "$DB_HOST" -u deploy_user -p"$DB_PASSWORD" "$DB_NAME" -e "
            SELECT table_name, table_rows 
            FROM information_schema.tables 
            WHERE table_schema = '$DB_NAME'
            ORDER BY table_rows DESC;
          "

    - name: ğŸ”„ é‡å¯åº”ç”¨æœåŠ¡
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        script: |
          echo "ğŸ”„ é‡å¯åº”ç”¨æœåŠ¡..."
          # ä¼˜é›…é‡å¯PM2åº”ç”¨
          if command -v pm2 &> /dev/null; then
            pm2 reload all --update-env || pm2 restart all
          fi
          
          # æˆ–è€…é‡å¯Dockerå®¹å™¨
          if command -v docker &> /dev/null; then
            docker ps -q | xargs -I {} docker restart {} || true
          fi

    - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        script: |
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -rf /tmp/deploy.tar.gz /tmp/node_modules
          echo "ğŸ†— æ¸…ç†å®Œæˆ"