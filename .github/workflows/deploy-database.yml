name: ğŸš€ æ•°æ®åº“å¢é‡éƒ¨ç½²åˆ°é˜¿é‡Œäº‘

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - '.github/workflows/deploy-database.yml'
      - '.env'
  workflow_dispatch:
    inputs:
      auto_execute:
        description: 'æ˜¯å¦è‡ªåŠ¨æ‰§è¡Œéƒ¨ç½²'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      output_file:
        description: 'è¾“å‡ºSQLæ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''

jobs:
  deploy-database:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm install

    - name: ğŸ” æ£€æŸ¥éƒ¨ç½²é…ç½®
      run: |
        AUTO_EXECUTE="${{ github.event.inputs.auto_execute || 'true' }}"
        OUTPUT_FILE="${{ github.event.inputs.output_file || '' }}"
        
        echo "ğŸš€ å¢é‡éƒ¨ç½²é…ç½®:"
        echo "ğŸ“¤ è‡ªåŠ¨æ‰§è¡Œ: $AUTO_EXECUTE"
        if [ -n "$OUTPUT_FILE" ]; then
          echo "ğŸ“¥ è¾“å‡ºæ–‡ä»¶: $OUTPUT_FILE"
        fi

    - name: ğŸš€ éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        command_timeout: "600s"
        script: |
          echo "ğŸš€ å¼€å§‹å¢é‡éƒ¨ç½²æ•°æ®åº“åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨..."
          
          # æ£€æŸ¥ Node.js æ˜¯å¦å®‰è£…
          if ! command -v node &> /dev/null; then
            echo "ğŸ“¦ å®‰è£… Node.js..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
          else
            echo "âœ… Node.js å·²å®‰è£…: $(node --version)"
          fi
          
          # æ£€æŸ¥ MySQL æ˜¯å¦å®‰è£…
          if ! command -v mysql &> /dev/null; then
            echo "ğŸ“¦ å®‰è£… MySQL..."
            sudo apt-get update
            sudo apt-get install -y mysql-server
            sudo systemctl start mysql
            sudo systemctl enable mysql
          else
            echo "âœ… MySQL å·²å®‰è£…"
            sudo systemctl start mysql || true
          fi
          
          # æ£€æŸ¥ MySQL æœåŠ¡çŠ¶æ€
          echo "ğŸ” MySQL æœåŠ¡çŠ¶æ€:"
          sudo systemctl status mysql --no-pager -l
          
          echo "âœ… æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡å®Œæˆ"

    - name: ğŸ“¤ ä¸Šä¼ é¡¹ç›®æ–‡ä»¶
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        source: "./"
        target: "/tmp/"

    - name: ğŸ”„ æ‰§è¡Œéƒ¨ç½²
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        command_timeout: "600s"
        script: |
          echo "ğŸ”„ æ‰§è¡Œå¢é‡éƒ¨ç½²..."
          
          AUTO_EXECUTE="${{ github.event.inputs.auto_execute || 'true' }}"
          OUTPUT_FILE="${{ github.event.inputs.output_file || '' }}"
          
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd /tmp
          
          # å®‰è£…ä¾èµ–
          echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
          npm install
          
          # ä½¿ç”¨é¡¹ç›®ä¸­çš„.envæ–‡ä»¶é…ç½®
          echo "ğŸ” ä½¿ç”¨é¡¹ç›®.envæ–‡ä»¶é…ç½®"
          
          # æ£€æŸ¥.envæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f ".env" ]; then
            echo "âœ… æ‰¾åˆ°.envæ–‡ä»¶ï¼Œä½¿ç”¨é¡¹ç›®é…ç½®"
            # åŠ è½½.envæ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡
            export $(cat .env | grep -v '^#' | xargs)
          else
            echo "âš ï¸  æœªæ‰¾åˆ°.envæ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
            # ä½¿ç”¨Secretsä½œä¸ºå¤‡ç”¨ï¼ˆå¦‚æœé…ç½®äº†çš„è¯ï¼‰
            export DB_HOST="${{ secrets.DB_HOST || 'localhost' }}"
            export DB_USER="${{ secrets.DB_USER || 'root' }}"
            export DB_PASSWORD="${{ secrets.DB_PASSWORD || '' }}"
            export DB_NAME="${{ secrets.DB_NAME || 'nest_db' }}"
            export DB_PORT="${{ secrets.DB_PORT || '3306' }}"
          fi
          
          echo "ğŸ” ç¯å¢ƒå˜é‡æ£€æŸ¥:"
          echo "   DB_HOST: $DB_HOST"
          echo "   DB_USER: $DB_USER"
          echo "   DB_PASSWORD: $DB_PASSWORD"
          echo "   DB_NAME: $DB_NAME"
          echo "   DB_PORT: $DB_PORT"
          
          # æ„å»ºéƒ¨ç½²å‘½ä»¤
          DEPLOY_CMD="node src/incremental-deploy.js"
          
          if [ "$AUTO_EXECUTE" = "true" ]; then
            DEPLOY_CMD="$DEPLOY_CMD --execute"
          fi
          
          if [ -n "$OUTPUT_FILE" ]; then
            DEPLOY_CMD="$DEPLOY_CMD -o $OUTPUT_FILE"
          fi
          
          echo "ğŸš€ æ‰§è¡Œå‘½ä»¤: $DEPLOY_CMD"
          $DEPLOY_CMD
          
          # éªŒè¯éƒ¨ç½²ç»“æœ
          echo "ğŸ” éªŒè¯éƒ¨ç½²ç»“æœ..."
          node -e "
            const mysql = require('mysql2/promise');
            require('dotenv').config();
            
            const config = {
              host: process.env.DB_HOST || 'localhost',
              user: process.env.DB_USER || 'root',
              password: process.env.DB_PASSWORD || '',
              database: process.env.DB_NAME || 'nest_db',
              charset: 'utf8mb4',
              port: process.env.DB_PORT || 3306
            };
            
            mysql.createConnection(config)
              .then(connection => {
                return connection.execute('SHOW TABLES')
                  .then(([rows]) => {
                    console.log('ğŸ“Š æ•°æ®åº“è¡¨æ•°é‡:', rows.length);
                    console.log('ğŸ“‹ è¡¨åˆ—è¡¨:');
                    rows.forEach(row => {
                      console.log('  -', Object.values(row)[0]);
                    });
                    return connection.end();
                  });
              })
              .catch(error => {
                console.error('âŒ éªŒè¯å¤±è´¥:', error.message);
                process.exit(1);
              });
          "
          
          echo "ğŸ‰ å¢é‡éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸŒ æ•°æ®åº“åœ°å€: $DB_HOST:$DB_PORT"
          echo "ğŸ“Š æ•°æ®åº“åç§°: $DB_NAME"
          echo "ğŸ”§ éƒ¨ç½²ç±»å‹: incremental"

    - name: ğŸ”„ é‡å¯åº”ç”¨
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        script: |
          echo "ğŸ”„ æ£€æŸ¥æ˜¯å¦éœ€è¦é‡å¯åº”ç”¨..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰åº”ç”¨éœ€è¦é‡å¯
          if command -v pm2 &> /dev/null; then
            echo "ğŸ”„ é‡å¯ PM2 åº”ç”¨..."
            pm2 restart all || echo "PM2 é‡å¯å¤±è´¥æˆ–æ— åº”ç”¨è¿è¡Œ"
          fi
          
          if command -v docker-compose &> /dev/null || command -v docker &> /dev/null; then
            echo "ğŸ”„ é‡å¯ Docker å®¹å™¨..."
            docker-compose restart 2>/dev/null || docker compose restart 2>/dev/null || echo "Docker Compose é‡å¯å¤±è´¥æˆ–æ— å®¹å™¨è¿è¡Œ"
          fi
          
          echo "âœ… åº”ç”¨é‡å¯æ£€æŸ¥å®Œæˆ"

    - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || '22' }}
        script: |
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -rf /tmp/*
          echo "âœ… æ¸…ç†å®Œæˆ" 